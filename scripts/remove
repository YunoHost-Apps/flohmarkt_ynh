#!/bin/bash

#=================================================
# GENERIC START
#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# STANDARD REMOVE
#=================================================
# REMOVE SERVICE INTEGRATION IN YUNOHOST
#=================================================
ynh_script_progression --message="Removing system configurations related to $app..." --weight=5

# Stop flohmarkt service
ynh_script_progression --message="Stopping $app..." --weight=2
yunohost service stop $app

# Remove the service from the list of services known by YunoHost (added from `yunohost service add`)
if ynh_exec_warn_less yunohost service status $app >/dev/null
then
	ynh_script_progression --message="Removing $app service integration..." --weight=2
	yunohost service remove $app
fi

ynh_script_progression --message="Stopping couchdb..." --weight=2
systemctl stop couchdb

ynh_script_progression --message="Removing databases..." --weight=2
# remove flohmarkt database and database user
# ynh_script_progression --message="removing flohmarkt couchdb user and database" --weight=2
# @@ wie komme ich hier an das admin-password, falls ich es brauche?
#      * brauche ich es? â†’ ja
# db:
# curl -X DELETE 'http://127.0.0.1:5984/flohmarkt' --user '<admin-user>:<admin-password>'
# user:
# curl -X DELETE "http://127.0.0.1:5984/_users/org.couchdb.user%3Aflohmarkt?rev=`curl -sX GET 'http://127.0.0.1:5984/_users/org.couchdb.user%3Aflohmarkt' --user 'admin:bla42fasel' | jq -r ._rev`" --user '<admin-user>:<admin-password>'
# @@ todo improve this like above
# https://codeberg.org/ChriChri/flohmarkt_ynh/issues/12
ynh_secure_remove --file=/var/lib/couchdb

# Remove the app-specific logrotate config
ynh_remove_logrotate

# Remove the dedicated NGINX config
ynh_remove_nginx_config

# Remove the dedicated Fail2Ban config
ynh_remove_fail2ban_config

# Remove home
ynh_script_progression --message="Removing data directory..." --weight=2
ynh_secure_remove --file=$data_dir

# remove systemd service
ynh_script_progression --message="Removing data directory..." --weight=2
ynh_remove_systemd_config

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression --message="Removal of $app completed" --last
